<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lesson 4 — Crypto Secrets with Pickle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0f1115; --card:#171a21; --text:#e7eaf0; --muted:#9aa3b2; --accent:#B1FF8C;
      --line:#242936; --outline:rgba(177,255,140,.35);
      --btn-h:52px; --radius:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

    .wrap{max-width:980px;margin:0 auto;padding:24px 16px 120px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:20px}
    header img.logo{width:28px;height:28px}
    header .brand{font-weight:700}
    header .spacer{flex:1}
    .lesson-title{margin:8px 0 4px 0;text-align:center;font-size:18px;color:var(--muted)}
    .lesson-h1{margin:0 0 8px 0;text-align:center;font-size:28px;font-weight:700}
    .lesson-sub{max-width:720px;margin:0 auto 24px auto;text-align:center;color:var(--muted);font-size:14px}

    /* Card area */
    .stage{display:flex;justify-content:center}
    .frame{width:680px;max-width:100%}
    .flip-wrap{perspective:1200px;position:relative;height:560px}
    .flip{position:absolute;inset:0;transform-style:preserve-3d;transition:transform .6s cubic-bezier(.2,.7,.2,1)}
    .flipped .flip{transform:rotateY(180deg)}
    .face{backface-visibility:hidden;position:absolute;inset:0;display:flex}
    .back{transform:rotateY(180deg)}

    .card{background:var(--card);border-radius:28px;display:flex;flex-direction:column;
      border:2px solid var(--outline);box-shadow:0 8px 28px rgba(0,0,0,.35);padding:18px 18px 80px; /* room for Flip */}
    .card-top{border-radius:20px;border:1px solid var(--line);overflow:hidden;display:flex;align-items:center;justify-content:center;height:230px;background:#f0d99a08}
    .card-top img{max-width:100%;max-height:100%;display:block}
    .card-body{padding:16px;text-align:center}
    .card-title{font-size:24px;font-weight:800;margin:8px 0 6px}
    .card-subttl{font-weight:700;color:var(--muted);margin:0 0 6px 0}
    .card-desc{font-size:14px;color:var(--muted);margin:0}

    /* Flip button inside card bottom */
    .flip-btn{position:absolute;left:50%;transform:translateX(-50%);
      bottom:18px;height:40px;padding:0 18px;border-radius:999px;border:none;font-weight:800;
      background:#fff;color:#0a0a0a;cursor:pointer}
    .flip-btn:active{transform:translateX(-50%) scale(.98)}

    /* Gallery nav under the card (centered) */
    .gallery-nav{display:flex;justify-content:center;align-items:center;gap:14px;margin:16px auto 0}
    .arrow{width:44px;height:44px;border-radius:999px;border:1px solid var(--line);background:transparent;
      color:var(--text);cursor:pointer;font-size:20px;line-height:44px}
    .arrow:disabled{opacity:.35;cursor:not-allowed}
    .index{color:var(--muted);font-size:13px;text-align:center;margin-top:6px}

    /* Bottom CTA centered */
    .footer{position:fixed;left:0;right:0;bottom:18px;display:flex;justify-content:center;pointer-events:none}
    .pill{min-height:var(--btn-h);border-radius:999px;background:var(--accent);color:#0a0a0a;
      font-weight:800;border:none;padding:0 20px;cursor:pointer;pointer-events:auto}

    img,button{user-select:none}
    @media (max-width:420px){
      .flip-wrap{height:520px}
      .card-top{height:200px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img class="logo" src="assets/logo-changelly.png" alt="Changelly" />
      <div class="brand">Changelly</div>
      <div class="spacer"></div>
      <div id="welcome" style="color:var(--muted);font-size:14px"></div>
    </header>

    <div class="lesson-title">Lesson 4</div>
    <h1 class="lesson-h1">Buy, hold, or run?<br/>Reading the market without the jargon</h1>
    <p class="lesson-sub">
      Flip through simple mood cards. Each shows what's happening on the market — and what a beginner-friendly action could be.
    </p>

    <!-- Card -->
    <div class="stage">
      <div class="frame">
        <div class="flip-wrap" id="deck">
          <div class="flip">
            <!-- FRONT -->
            <section class="face front">
              <article class="card">
                <div class="card-top">
                  <img id="imgFront" src="" alt="Card image"/>
                </div>
                <div class="card-body">
                  <div id="titleFront" class="card-title">—</div>
                  <p class="card-subttl">What’s happening:</p>
                  <p id="descFront" class="card-desc">—</p>
                </div>
                <button id="btnFlip1" class="flip-btn" aria-label="Flip card">Flip ⟳</button>
              </article>
            </section>
            <!-- BACK -->
            <section class="face back">
              <article class="card">
                <div class="card-top">
                  <img id="imgBack" src="" alt="Card image"/>
                </div>
                <div class="card-body">
                  <div id="titleBack" class="card-title">—</div>
                  <p class="card-subttl">What it means:</p>
                  <p id="descBack" class="card-desc">—</p>
                </div>
                <button id="btnFlip2" class="flip-btn" aria-label="Flip card back">Flip ⟳</button>
              </article>
            </section>
          </div>
        </div>

        <!-- Centered gallery controls under the card -->
        <div class="gallery-nav">
          <button id="prev" class="arrow" aria-label="Previous">‹</button>
          <div id="index" class="index">Card 1/7</div>
          <button id="next" class="arrow" aria-label="Next">›</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom centered CTA -->
  <div class="footer">
    <button id="cta" class="pill" onclick="window.pickleNext()">Level up →</button>
  </div>

  <script>
    // ===== Gate (email + progress) =====
    (function gate(){
      const email = localStorage.getItem('pickle_email');
      if(!email){ location.href = 'index.html#join'; return; }
      const name = localStorage.getItem('pickle_name') || '';
      const short = name ? name.split(' ')[0] : '';
      document.getElementById('welcome').textContent = short ? `👋 Welcome back, ${short}!` : '';

      const progress = localStorage.getItem('pickle_progress') || '';
      const last = (progress.match(/l\d/g) || []).pop() || 'l1';
      const order = ['l1','l2','l3','l4','l5'];
      const lastIdx = order.indexOf(last);
      const myIdx = order.indexOf('l4');
      if(lastIdx < myIdx-1){
        location.href = order[lastIdx].replace('l','lesson') + '.html';
        return;
      }
    })();

    // ===== Next lesson =====
    window.pickleNext = function(){
      const progress = localStorage.getItem('pickle_progress') || '';
      if(!/l4/.test(progress)){
        const upd = progress ? (progress + ' l4') : 'l4';
        localStorage.setItem('pickle_progress', upd.trim());
      }
      location.href = 'lesson5.html';
    };

    // ===== Deck data (images identical on both sides) =====
    const cards = [
      {img:'assets/l4-card-1.png', titleF:'Price is pumping', descF:"Sudden spike in price, everyone’s tweeting about it",
       titleB:'What it means', descB:"Likely hype-driven move. Expect volatility. Small entries only, set stops."},
      {img:'assets/l4-card-2.png', titleF:'Slow & steady uptrend', descF:"Higher highs and higher lows",
       titleB:'What it means', descB:"Trend is your friend. DCA or buy pullbacks; avoid chasing green candles."},
      {img:'assets/l4-card-3.png', titleF:'Sideways chop', descF:"Price stuck in a range; volume low",
       titleB:'What it means', descB:"Wait for breakout. Consider range trading only if you know risk."},
      {img:'assets/l4-card-4.png', titleF:'Sell-off / dump', descF:"Sharp red move on rising volume",
       titleB:'What it means', descB:"Don’t catch falling knives. If buying, do it in small, spaced bids."},
      {img:'assets/l4-card-5.png', titleF:'Retest after breakout', descF:"Price breaks range then comes back to test it",
       titleB:'What it means', descB:"Healthy if level holds. Entry near retest with invalidation just below."},
      {img:'assets/l4-card-6.png', titleF:'Bearish divergence', descF:"Price up, momentum down",
       titleB:'What it means', descB:"Weakening push. Take profits or tighten stops."},
      {img:'assets/l4-card-7.png', titleF:'Capitulation wick', descF:"Long wick down then quick recovery",
       titleB:'What it means', descB:"Panic flush possibly over. Consider staged buys; volatility remains."},
    ];

    // DPR helper (1x/2x/3x)
    function bestSrc(path){
      const dpr = Math.min(3, Math.max(1, Math.round(window.devicePixelRatio || 1)));
      if(dpr===1) return path;
      const ext = path.split('.').pop();
      const base = path.slice(0, -(ext.length+1));
      return `${base}@${dpr}x.${ext}`;
    }

    // ===== Render / controls =====
    let idx = 0;
    const deck = document.getElementById('deck');
    const flipRoot = deck.querySelector('.flip');
    const frontImg = deck.querySelector('#imgFront');
    const backImg  = deck.querySelector('#imgBack');
    const tF = deck.querySelector('#titleFront');
    const dF = deck.querySelector('#descFront');
    const tB = deck.querySelector('#titleBack');
    const dB = deck.querySelector('#descBack');
    const prev = document.getElementById('prev');
    const next = document.getElementById('next');
    const indexEl = document.getElementById('index');
    const btnFlip1 = document.getElementById('btnFlip1');
    const btnFlip2 = document.getElementById('btnFlip2');

    function render(){
      const c = cards[idx];
      frontImg.src = bestSrc(c.img);
      backImg.src  = bestSrc(c.img);
      tF.textContent = c.titleF;
      dF.textContent = c.descF;
      tB.textContent = c.titleB;
      dB.textContent = c.descB;

      deck.classList.remove('flipped');
      prev.disabled = idx===0;
      next.disabled = idx===cards.length-1;
      indexEl.textContent = `Card ${idx+1}/${cards.length}`;
    }
    render();

    prev.addEventListener('click', ()=>{ if(idx>0){ idx--; render(); }});
    next.addEventListener('click', ()=>{ if(idx<cards.length-1){ idx++; render(); }});

    function flip(){ deck.classList.toggle('flipped'); }
    btnFlip1.addEventListener('click', flip);
    btnFlip2.addEventListener('click', flip);

    // Flip on tap anywhere inside the card (кроме самой кнопки)
    deck.addEventListener('click', (e)=>{
      if(e.target.closest('.flip-btn')) return;
      flip();
    }, {passive:true});
  </script>
</body>
</html>
