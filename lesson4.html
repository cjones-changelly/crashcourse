<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lesson 4 â€” Crypto Secrets with Pickle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0f1115; --card:#171a21; --text:#e7eaf0; --muted:#9aa3b2; --accent:#B1FF8C;
      --line:#242936; --ok:#33d69e; --warn:#ffb84d; --btn-h:52px; --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

    /* layout */
    .wrap{max-width:980px;margin:0 auto;padding:24px 16px 100px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:20px}
    header img.logo{width:28px;height:28px}
    header .brand{font-weight:700}
    header .spacer{flex:1}
    .lesson-title{margin:8px 0 4px 0;text-align:center;font-size:18px;color:var(--muted)}
    .lesson-h1{margin:0 0 8px 0;text-align:center;font-size:28px;font-weight:700}
    .lesson-sub{max-width:720px;margin:0 auto 24px auto;text-align:center;color:var(--muted);font-size:14px}

    /* card stage */
    .stage{display:flex;justify-content:center}
    .card-shell{width:640px;max-width:100%;background:var(--card);border:1px solid var(--line);
      border-radius:24px;padding:18px 18px 84px 18px;position:relative;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    .card-img{height:210px;border-radius:16px;background:#f0d99a0a;border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;overflow:hidden}
    .card-img img{max-width:100%;max-height:100%;display:block}

    .card-body{padding:12px 8px 0 8px;text-align:center}
    .card-title{font-size:22px;font-weight:800;margin:6px 0}
    .card-sub{font-size:14px;color:var(--muted);margin:0}

    /* flip */
    .flip-wrap{perspective:1200px}
    .flip{position:relative;transform-style:preserve-3d;transition:transform .6s cubic-bezier(.2,.7,.2,1)}
    .flipped .flip{transform:rotateY(180deg)}
    .face{backface-visibility:hidden;position:absolute;inset:0;display:flex;flex-direction:column}
    .back{transform:rotateY(180deg)}
    .face .card-shell{height:100%}

    /* controls */
    .turn-btn{position:absolute;left:50%;transform:translateX(-50%);
      bottom:18px;height:40px;padding:0 18px;border-radius:999px;border:none;font-weight:800;
      background:#fff;color:#0a0a0a;cursor:pointer}
    .turn-btn:active{transform:translateX(-50%) scale(.98)}

    .nav{display:flex;align-items:center;justify-content:space-between;max-width:640px;margin:16px auto 0}
    .arrow{width:44px;height:44px;border-radius:999px;border:1px solid var(--line);background:transparent;
      color:var(--text);cursor:pointer}
    .arrow:disabled{opacity:.35;cursor:not-allowed}
    .pill{min-height:var(--btn-h);border-radius:999px;background:var(--accent);color:#0a0a0a;
      font-weight:800;border:none;padding:0 18px;cursor:pointer}

    .index{color:var(--muted);font-size:13px;text-align:center;margin-top:6px}

    /* no text selection on images/buttons */
    img,button{user-select:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img class="logo" src="assets/logo-changelly.png" alt="Changelly" />
      <div class="brand">Changelly</div>
      <div class="spacer"></div>
      <div id="welcome" style="color:var(--muted);font-size:14px"></div>
    </header>

    <div class="lesson-title">Lesson 4</div>
    <h1 class="lesson-h1">Buy, hold, or run?<br/>Reading the market without the jargon</h1>
    <p class="lesson-sub">
      Flip through simple mood cards. Each shows what's happening on the market â€” and what a beginner-friendly action could be.
    </p>

    <!-- Cards -->
    <div id="deck" class="stage">
      <div class="flip-wrap" style="width:100%;max-width:640px;height:520px;position:relative">
        <div class="flip">
          <!-- FRONT -->
          <section class="face front">
            <div class="card-shell">
              <div class="card-img">
                <img id="imgFront" src="" alt="Card image"/>
              </div>
              <div class="card-body">
                <div id="titleFront" class="card-title">â€”</div>
                <p id="descFront" class="card-sub">â€”</p>
              </div>
              <button class="turn-btn" id="btnFlip1" aria-label="Turn card">Turn âŸ³</button>
            </div>
          </section>
          <!-- BACK -->
          <section class="face back">
            <div class="card-shell">
              <div class="card-img">
                <img id="imgBack" src="" alt="Card image"/>
              </div>
              <div class="card-body">
                <div id="titleBack" class="card-title">â€”</div>
                <p id="descBack" class="card-sub">â€”</p>
              </div>
              <button class="turn-btn" id="btnFlip2" aria-label="Turn card back">Turn âŸ³</button>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- Nav -->
    <div class="nav">
      <button id="prev" class="arrow" aria-label="Previous card">â€¹</button>
      <button id="next" class="arrow" aria-label="Next card">â€º</button>
      <button id="cta" class="pill" onclick="window.pickleNext()">Level up â†’</button>
    </div>
    <div id="index" class="index">Card 1/7</div>
  </div>

  <script>
    // ==== Gate: email + progress ====
    (function gate(){
      const email = localStorage.getItem('pickle_email');
      if(!email){ location.href = 'index.html#join'; return; }

      // welcome text in header (first name cut)
      const name = localStorage.getItem('pickle_name') || '';
      const short = name ? name.split(' ')[0] : '';
      document.getElementById('welcome').textContent = short ? `ðŸ‘‹ Welcome back, ${short}!` : '';

      const progress = localStorage.getItem('pickle_progress') || '';
      const last = (progress.match(/l\d/g) || []).pop() || 'l1';
      const order = ['l1','l2','l3','l4','l5'];
      const lastIdx = order.indexOf(last);
      const myIdx = order.indexOf('l4');
      if(lastIdx < myIdx-1){
        // trying to jump ahead â†’ send back to last available
        const send = order[lastIdx];
        // tiny shake on a "Continue" concept (if present on previous)
        location.href = send.replace('l','lesson') + '.html';
        return;
      }
    })();

    // ==== Next lesson helper ====
    window.pickleNext = function(){
      // set progress to l4 if not already
      const progress = localStorage.getItem('pickle_progress') || '';
      if(!/l4/.test(progress)){
        const upd = progress ? (progress + ' l4') : 'l4';
        localStorage.setItem('pickle_progress', upd.trim());
      }
      // go to next lesson (adjust if file name differs)
      location.href = 'lesson5.html';
    };

    // ==== Deck data (placeholders; images identical on both sides) ====
    const cards = [
      {img:'assets/l4-card-1.png', titleF:'Price is pumping', descF:"Sudden spike in price, everyoneâ€™s tweeting about it",
       titleB:'What it means', descB:"Likely hype-driven move. Expect volatility. Small entries only, set stops."},
      {img:'assets/l4-card-2.png', titleF:'Slow & steady uptrend', descF:"Higher highs and higher lows",
       titleB:'What it means', descB:"Trend is your friend. DCA or buy pullbacks; avoid chasing green candles."},
      {img:'assets/l4-card-3.png', titleF:'Sideways chop', descF:"Price stuck in a range; volume low",
       titleB:'What it means', descB:"Wait for breakout. Consider range trading only if you know risk."},
      {img:'assets/l4-card-4.png', titleF:'Sell-off / dump', descF:"Sharp red move on rising volume",
       titleB:'What it means', descB:"Donâ€™t catch falling knives. If buying, do it in small, spaced bids."},
      {img:'assets/l4-card-5.png', titleF:'Retest after breakout', descF:"Price breaks range then comes back to test it",
       titleB:'What it means', descB:"Healthy if level holds. Entry near retest with invalidation just below."},
      {img:'assets/l4-card-6.png', titleF:'Bearish divergence', descF:"Price up, momentum down",
       titleB:'What it means', descB:"Weakening push. Take profits or tighten stops."},
      {img:'assets/l4-card-7.png', titleF:'Capitulation wick', descF:"Long wick down then quick recovery",
       titleB:'What it means', descB:"Panic flush possibly over. Consider staged buys; volatility remains."},
    ];

    // pick best DPR asset (1x/2x/3x)
    function bestSrc(path){
      const dpr = Math.min(3, Math.max(1, Math.round(window.devicePixelRatio || 1)));
      if(dpr===1) return path;
      const ext = path.split('.').pop();
      const base = path.slice(0, -(ext.length+1));
      return `${base}@${dpr}x.${ext}`;
    }

    // ==== Deck logic ====
    let idx = 0;
    const deck = document.querySelector('.flip-wrap');
    const flipRoot = deck.querySelector('.flip');
    const frontImg = deck.querySelector('#imgFront');
    const backImg  = deck.querySelector('#imgBack');
    const tF = deck.querySelector('#titleFront');
    const dF = deck.querySelector('#descFront');
    const tB = deck.querySelector('#titleBack');
    const dB = deck.querySelector('#descBack');
    const prev = document.getElementById('prev');
    const next = document.getElementById('next');
    const indexEl = document.getElementById('index');
    const btnFlip1 = document.getElementById('btnFlip1');
    const btnFlip2 = document.getElementById('btnFlip2');

    function render(){
      const c = cards[idx];
      frontImg.src = bestSrc(c.img);
      backImg.src  = bestSrc(c.img); // same image on both sides
      tF.textContent = c.titleF;
      dF.textContent = c.descF;
      tB.textContent = c.titleB;
      dB.textContent = c.descB;

      deck.classList.remove('flipped');
      prev.disabled = idx===0;
      next.disabled = idx===cards.length-1;
      indexEl.textContent = `Card ${idx+1}/${cards.length}`;
    }
    render();

    // arrows (no swipe)
    prev.addEventListener('click', ()=>{ if(idx>0){ idx--; render(); }});
    next.addEventListener('click', ()=>{ if(idx<cards.length-1){ idx++; render(); }});

    // flip both ways
    function flip(){ deck.classList.toggle('flipped'); }
    btnFlip1.addEventListener('click', flip);
    btnFlip2.addEventListener('click', flip);

    // also flip on image/titles tap
    deck.addEventListener('click', (e)=>{
      // ignore clicks on nav buttons; only within card faces
      if(e.target.closest('.turn-btn')) return;
      flip();
    }, {passive:true});
  </script>
</body>
</html>
