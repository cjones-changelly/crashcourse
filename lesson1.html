<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lesson 1 — Why you're still early</title>
  <style>
    :root{
      --bg:#0f1115; --card:#171a21; --text:#e7eaf0; --muted:#9aa3b2;
      --brand:#B1FF8C; --line:#242936;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:15px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    a{color:inherit; text-decoration:none}

    /* Header (как в lesson2) */
    .bar{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px;
      background:linear-gradient(180deg,rgba(15,17,21,.95),rgba(15,17,21,.7) 60%,rgba(15,17,21,0));
      backdrop-filter:blur(8px);
    }
    .back{ color:var(--text); text-decoration:none; font-size:24px; line-height:1 }
    .logo{ height:44px; width:auto; object-fit:contain; display:block }
    @media (max-width:480px){ .logo{ height:36px } }

    .wrap{ max-width:780px; margin:0 auto; padding: 10px 16px 40px }

    /* Eyebrow + Title (как в lesson2) */
    .eyebrow{ margin-top:8px; text-align:center; color:var(--muted); font-weight:600 }
    .title{
      margin:6px auto 18px; text-align:center; max-width:680px;
      font-family:Georgia,serif; font-style:italic; font-size:26px; line-height:1.25; font-weight:600;
    }

    /* Player */
    .player{
      background:var(--card);
      width:100%; aspect-ratio:16/9;
      border-radius:16px; display:flex; align-items:center; justify-content:center;
      margin:16px 0 28px; box-shadow:0 12px 28px rgba(0,0,0,.4);
      border:1px solid var(--line);
      overflow:hidden;
    }
    /* видео заполняет «окошко» */
    .player video{
      width:100%; height:100%;
      display:block; object-fit:cover;
    }
    .play{
      background:none; border:none; cursor:pointer;
      font-size:64px; line-height:1; color:var(--brand);
    }

    /* CTA (точно как в lesson2) */
    .cta{ display:flex; justify-content:center; margin-top:4px }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:16px 28px; border:0; border-radius:999px;
      background:var(--brand); color:#07110c; font-weight:700;
      box-shadow:0 6px 14px rgba(177,255,140,.25);
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-KVRG5B0DWZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-KVRG5B0DWZ');
    function track(event, params){ try{ gtag('event', event, params||{}); }catch(_){ } }
  </script>
</head>
<body>
  <header class="bar">
    <a href="index.html" class="back" aria-label="Back" onclick="pickleBack(); track('lesson1_back_click'); return false;">←</a>
    <img
      class="logo"
      src="assets/logo-changelly.png"
      srcset="assets/logo-changelly.png 1x, assets/logo-changelly@2x.png 2x, assets/logo-changelly@3x.png 3x"
      alt="Changelly">
  </header>

  <main class="wrap">
    <div class="eyebrow">Lesson 1</div>
    <h1 class="title">Why you're still early<br>(and what to do about it)</h1>

    <div class="player" role="region" aria-label="Lesson video">
      <!-- ВИДЕО -->
      <video id="lesson1Video"
             controls
             playsinline
             webkit-playsinline
             preload="metadata"
             poster="assets/lesson1-poster.png"></video>
    </div>

    <div class="cta">
      <a href="lesson2.html" class="btn" onclick="pickleNext(); track('lesson1_next_click'); return false;">Done!</a>
    </div>
  </main>

  <!-- hls.js для Android/Chrome; dash.js как резерв для DASH -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
  <script>
    (function(){
      const v = document.getElementById('lesson1Video');

      // Постер @2x/@3x по DPR
      (function setPosterByDPR(){
        const dpr = Math.min(3, Math.max(1, Math.round(window.devicePixelRatio || 1)));
        const base = 'assets/lesson1-poster';
        const suffix = dpr > 1 ? '@' + dpr + 'x' : '';
        v.setAttribute('poster', base + suffix + '.png');
      })();

      const SRC_HLS  = 'https://customer-xmva784s4fdt6l1s.cloudflarestream.com/680cdaa0a479c0162c213aa8c3bc4149/manifest/video.m3u8';
      const SRC_DASH = 'https://customer-xmva784s4fdt6l1s.cloudflarestream.com/680cdaa0a479c0162c213aa8c3bc4149/manifest/video.mpd';

      // iOS/WKWebView — нативный HLS
      if (v.canPlayType('application/vnd.apple.mpegurl')) {
        v.src = SRC_HLS;
      }
      // Android/Chrome — через hls.js
      else if (window.Hls && Hls.isSupported()) {
        const hls = new Hls({lowLatencyMode:true});
        hls.loadSource(SRC_HLS);
        hls.attachMedia(v);
      }
      // Резерв — DASH через dash.js
      else if (window.dashjs) {
        const player = dashjs.MediaPlayer().create();
        player.initialize(v, SRC_DASH, false);
      } else {
        // Последний резерв — всё равно попробуем HLS
        v.src = SRC_HLS;
      }

      // событие на play
      v.addEventListener('play', ()=>track('lesson1_video_play'));
    })();
  </script>

  <!-- прогресс/гейтинг -->
  <script>
  (function(){
    const LESSON_ID = 'l1';
    const order = ['l1','l2','l3','l4','l5'];
    const idToIdx = Object.fromEntries(order.map((id,i)=>[id,i]));
    const tg = window.Telegram?.WebApp;

    const fileFor = id => `lesson${id.replace('l','')}.html`;
    const lastId = localStorage.getItem('pickle_progress') || 'l1';
    const hasEmail = !!localStorage.getItem('pickle_email');

    // без e-mail — на форму
    if (!hasEmail) { location.replace('index.html#join'); return; }
    // нельзя входить дальше достигнутого
    if (idToIdx[LESSON_ID] > idToIdx[lastId]) {
      try{ tg?.HapticFeedback?.impactOccurred('light'); }catch(_){}
      location.replace(fileFor(lastId)); return;
    }

    // кнопки
    window.pickleNext = function(){
      const curIdx = idToIdx[LESSON_ID];
      const savedIdx = idToIdx[localStorage.getItem('pickle_progress') || 'l1'];
      const nextId = order[Math.min(curIdx + 1, order.length - 1)];

      if (curIdx >= savedIdx) {
        localStorage.setItem('pickle_progress', nextId);
        try{ tg?.HapticFeedback?.notificationOccurred('success'); }catch(_){}
      }

      if (curIdx + 1 < order.length) location.href = fileFor(nextId);
      else location.href = 'index.html#breakdown';
    };
    window.pickleBack = function(){ location.href = 'index.html'; };
  })();
  </script>
</body>
</html>
